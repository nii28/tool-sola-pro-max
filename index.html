<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sola Pro v1.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'sola-gold': '#d4af37',
                        'sola-dark': '#080808',
                        'sola-panel': '#121212',
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            transition: background-color 0.5s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #080808;
            color: #f1f1f1;
            background-size: cover;
            background-position: center;
        }

        .panel-glass {
            background: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 1.5rem;
        }

        /* Logo Glow Animation */
        .logo-glow {
            position: relative;
            animation: logo-float 3s infinite ease-in-out;
        }
        .logo-glow::after {
            content: '';
            position: absolute;
            inset: -10px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.5) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            animation: pulse-aura 2s infinite ease-in-out;
        }
        @keyframes pulse-aura {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.4); opacity: 0.8; }
        }
        @keyframes logo-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* Subtle Dust Particles */
        .dust {
            position: fixed;
            background: rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: drift var(--d) infinite linear;
        }
        @keyframes drift {
            from { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            20% { opacity: 0.4; }
            80% { opacity: 0.4; }
            to { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        .nav-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 1rem;
            color: #888;
        }
        .nav-btn.active {
            background: linear-gradient(135deg, #d4af37, #b8860b);
            color: white !important;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .nav-btn:hover:not(.active) {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }

        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: flex; flex-direction: column; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 10px; }

        .input-box {
            background: rgba(25, 25, 25, 0.7);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 1rem;
            transition: all 0.3s;
        }
        .input-box:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.1);
            outline: none;
        }
    </style>
</head>
<body class="dark flex flex-col">

    <div id="dust-layer"></div>

    <!-- Header -->
    <header class="h-16 panel-glass m-4 flex items-center justify-between px-6 z-50 shrink-0">
        <div class="flex items-center gap-4">
            <div class="logo-glow">
                <div class="w-10 h-10 rounded-full bg-sola-gold flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-bolt-lightning text-xl"></i>
                </div>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-sola-gold">SOLA PRO <span class="text-white font-light">v1.0</span></h1>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[9px] uppercase tracking-widest text-zinc-500 font-bold">Hệ thống AI đang trực tuyến</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleFullscreen()" class="w-9 h-9 flex items-center justify-center text-zinc-500 hover:text-sola-gold transition"><i class="fa-solid fa-expand"></i></button>
            <button onclick="toggleDarkMode()" class="w-9 h-9 flex items-center justify-center text-zinc-500 hover:text-sola-gold transition"><i id="dark-icon" class="fa-solid fa-moon"></i></button>
            <div class="h-6 w-[1px] bg-zinc-800 mx-2"></div>
            <button onclick="resetApp()" class="w-9 h-9 flex items-center justify-center text-zinc-500 hover:text-red-500 transition"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden p-4 pt-0 gap-4">
        <!-- Sidebar -->
        <aside class="panel-glass w-20 lg:w-60 flex flex-col p-3 shrink-0">
            <nav class="space-y-2">
                <button onclick="switchTab('tab-translate')" id="nav-tab-translate" class="nav-btn active w-full flex items-center justify-center lg:justify-start gap-4 p-4 font-bold">
                    <i class="fa-solid fa-language text-lg"></i>
                    <span class="hidden lg:block">Dịch thuật</span>
                </button>
                <button onclick="switchTab('tab-file')" id="nav-tab-file" class="nav-btn w-full flex items-center justify-center lg:justify-start gap-4 p-4 font-bold">
                    <i class="fa-solid fa-file-invoice text-lg"></i>
                    <span class="hidden lg:block">Dịch tệp tin</span>
                </button>
                <button onclick="switchTab('tab-cleaner')" id="nav-tab-cleaner" class="nav-btn w-full flex items-center justify-center lg:justify-start gap-4 p-4 font-bold">
                    <i class="fa-solid fa-wand-magic-sparkles text-lg"></i>
                    <span class="hidden lg:block">Lọc văn bản</span>
                </button>
                <button onclick="switchTab('tab-analyze')" id="nav-tab-analyze" class="nav-btn w-full flex items-center justify-center lg:justify-start gap-4 p-4 font-bold">
                    <i class="fa-solid fa-microchip text-lg"></i>
                    <span class="hidden lg:block">Phân tích AI</span>
                </button>
                <button onclick="switchTab('tab-notes')" id="nav-tab-notes" class="nav-btn w-full flex items-center justify-center lg:justify-start gap-4 p-4 font-bold">
                    <i class="fa-solid fa-book-bookmark text-lg"></i>
                    <span class="hidden lg:block">Ghi chú</span>
                </button>
            </nav>
            <button onclick="switchTab('tab-settings')" id="nav-tab-settings" class="nav-btn w-full flex items-center justify-center lg:justify-start gap-4 p-4 mt-auto border-t border-zinc-800/50 pt-4 font-bold">
                <i class="fa-solid fa-gear text-lg"></i>
                <span class="hidden lg:block">Cài đặt</span>
            </button>
        </aside>

        <!-- Content -->
        <main class="flex-1 min-w-0">
            
            <!-- TAB: DỊCH THUẬT -->
            <div id="tab-translate" class="tab-content active gap-4">
                <div class="panel-glass p-4 grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0">
                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase px-2">Nguồn văn bản</span>
                        <select id="lang-from" class="input-box p-3 text-sm">
                            <option value="Auto">Tự động nhận diện</option>
                            <option value="Chinese">Tiếng Trung (Trung)</option>
                            <option value="Japanese">Tiếng Nhật (Nhật)</option>
                            <option value="Korean">Tiếng Hàn (Hàn)</option>
                            <option value="English">Tiếng Anh</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase px-2">Phong cách dịch</span>
                        <select id="trans-style" class="input-box p-3 text-sm">
                            <option value="Dịch mượt mà, tự nhiên, thuần Việt, phong cách Light Novel.">Mượt mà (Light Novel)</option>
                            <option value="Dùng từ Hán Việt sang trọng, phù hợp cổ trang, kiếm hiệp.">Hán Việt (Cổ Trang)</option>
                            <option value="Dịch chính xác từng chữ, giữ nguyên cấu trúc văn bản.">Sát nghĩa (Technical)</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase px-2">Ghi chú bổ sung</span>
                        <input type="text" id="custom-prompt" placeholder="Ví dụ: Đổi xưng hô..." class="input-box p-3 text-sm">
                    </div>
                </div>
                <div class="flex-1 flex flex-col md:flex-row gap-4 min-h-0">
                    <textarea id="trans-input" class="input-box flex-1 p-6 resize-none text-sm leading-relaxed" placeholder="Dán nội dung cần dịch tại đây..."></textarea>
                    <div class="flex md:flex-col justify-center gap-4">
                        <button onclick="executeTranslate()" class="w-16 h-16 bg-sola-gold rounded-2xl flex items-center justify-center text-white shadow-xl hover:scale-105 active:scale-95 transition-all">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="flex-1 relative">
                        <textarea id="trans-output" class="input-box w-full h-full p-6 resize-none text-sm leading-relaxed" readonly placeholder="Kết quả dịch thuật..."></textarea>
                        <div id="loading-trans" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm flex flex-col items-center justify-center gap-3 rounded-2xl">
                            <div class="w-10 h-10 border-4 border-white/20 border-t-sola-gold rounded-full animate-spin"></div>
                            <span class="text-[10px] font-bold text-sola-gold tracking-[0.2em]">ĐANG XỬ LÝ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: DỊCH TỆP TIN (EPUB/TXT) -->
            <div id="tab-file" class="tab-content gap-4">
                <div class="panel-glass p-4 flex flex-wrap items-center gap-4 shrink-0">
                    <label class="bg-sola-gold px-6 py-3 rounded-xl cursor-pointer text-sm font-bold flex items-center gap-2 hover:opacity-90">
                        <i class="fa-solid fa-file-circle-plus"></i> Nhập File (EPUB/TXT)
                        <input type="file" id="file-upload" accept=".epub,.txt" class="hidden" onchange="handleFileUpload(this)">
                    </label>
                    <button onclick="translateCurrentChapter()" class="px-6 py-3 bg-zinc-800 border border-sola-gold/30 rounded-xl text-sola-gold text-sm font-bold hover:bg-sola-gold/10">Dịch trang này</button>
                    <button id="btn-auto-trans" onclick="toggleAutoTranslate()" class="px-6 py-3 bg-zinc-900 text-zinc-400 rounded-xl text-sm font-bold hover:text-white border border-zinc-800">Dịch tự động</button>
                    <div class="ml-auto text-xs text-zinc-500 font-medium">Hỗ trợ tự động chia chương</div>
                </div>
                <div class="flex-1 flex gap-4 min-h-0">
                    <div class="hidden lg:flex w-64 panel-glass flex-col shrink-0 overflow-hidden">
                        <div class="p-4 border-b border-zinc-800/50 text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Cấu trúc tệp</div>
                        <div id="chapter-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                    </div>
                    <div class="flex-1 flex flex-col gap-3 min-w-0">
                        <div class="panel-glass px-5 py-3 flex justify-between items-center text-xs font-bold">
                            <button onclick="navChapter(-1)" class="p-2 hover:text-sola-gold"><i class="fa-solid fa-arrow-left"></i></button>
                            <span id="current-chapter-title" class="truncate opacity-50 italic">Tệp tin chưa được nạp...</span>
                            <button onclick="navChapter(1)" class="p-2 hover:text-sola-gold"><i class="fa-solid fa-arrow-right"></i></button>
                        </div>
                        <div class="flex-1 flex flex-col lg:flex-row gap-4 min-h-0">
                            <div id="reader-raw" class="flex-1 input-box p-8 overflow-y-auto text-sm leading-relaxed whitespace-pre-wrap font-serif"></div>
                            <div class="flex-1 input-box p-8 overflow-y-auto text-sm leading-relaxed whitespace-pre-wrap relative">
                                <div id="reader-trans" class="text-sola-gold"></div>
                                <div id="loading-reader" class="hidden absolute inset-0 flex items-center justify-center bg-black/40 backdrop-blur-sm rounded-2xl">
                                    <div class="w-8 h-8 border-4 border-zinc-800 border-t-sola-gold rounded-full animate-spin"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: LỌC VĂN BẢN -->
            <div id="tab-cleaner" class="tab-content gap-4">
                <div class="panel-glass p-6 flex flex-col lg:flex-row items-center gap-6 shrink-0">
                    <div class="flex-1 flex flex-wrap gap-2">
                        <button onclick="cleanText('html')" class="px-5 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-xs font-bold rounded-lg transition border border-zinc-700">Xóa HTML</button>
                        <button onclick="cleanText('zh')" class="px-5 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-xs font-bold rounded-lg transition border border-zinc-700">Xóa ký tự lạ (Trung/Nhật/Hàn)</button>
                        <button onclick="cleanText('space')" class="px-5 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-xs font-bold rounded-lg transition border border-zinc-700">Dọn khoảng trắng</button>
                    </div>
                    <label class="bg-zinc-100 text-zinc-900 px-6 py-2.5 rounded-lg cursor-pointer text-xs font-bold flex items-center gap-2">
                        <i class="fa-solid fa-file-signature"></i> Xử lý Tệp (EPUB/TXT)
                        <input type="file" id="cleaner-file-upload" accept=".epub,.txt" class="hidden" onchange="handleCleanerFile(this)">
                    </label>
                </div>
                <div class="flex-1 flex flex-col md:flex-row gap-4 min-h-0">
                    <textarea id="cleaner-input" class="input-box flex-1 p-6 font-mono text-xs opacity-60" placeholder="Nội dung gốc..."></textarea>
                    <textarea id="cleaner-output" class="input-box flex-1 p-6 font-mono text-xs text-green-400" placeholder="Nội dung đã làm sạch..."></textarea>
                </div>
            </div>

            <!-- TAB: PHÂN TÍCH AI -->
            <div id="tab-analyze" class="tab-content items-center justify-center p-6">
                <div class="panel-glass max-w-5xl w-full p-10 flex flex-col h-full overflow-hidden shadow-2xl">
                    <h2 class="text-2xl font-bold text-center text-sola-gold mb-8 uppercase tracking-widest">Trợ lý phân tích văn bản AI</h2>
                    <textarea id="analyze-input" class="input-box w-full h-40 p-6 text-sm mb-6" placeholder="Dán câu văn hoặc đoạn hội thoại khó hiểu tại đây..."></textarea>
                    <button onclick="executeAnalyze()" class="bg-sola-gold w-full py-5 rounded-2xl text-white font-bold text-lg hover:brightness-110 active:scale-95 transition-all mb-8 shadow-lg shadow-sola-gold/10">BẮT ĐẦU PHÂN TÍCH</button>
                    <div id="analyze-output" class="hidden flex-1 overflow-y-auto p-8 bg-black/40 border border-zinc-800 rounded-2xl text-sm leading-relaxed whitespace-pre-wrap"></div>
                </div>
            </div>

            <!-- TAB: GHI CHÚ -->
            <div id="tab-notes" class="tab-content gap-4">
                <div class="panel-glass p-6 border-l-4 border-sola-gold flex items-center justify-between">
                    <div>
                        <h2 class="font-bold text-sola-gold">Cơ sở dữ liệu thuật ngữ</h2>
                        <p class="text-xs text-zinc-500 mt-1 italic">Dùng để nhắc AI nhớ tên nhân vật, địa danh và văn phong của riêng bạn.</p>
                    </div>
                    <i class="fa-solid fa-pen-nib text-3xl text-sola-gold/20"></i>
                </div>
                <textarea id="note-area" oninput="saveNotes()" class="input-box flex-1 p-10 text-lg leading-relaxed border-dashed" placeholder="Dán từ điển thuật ngữ của bạn vào đây..."></textarea>
            </div>

            <!-- TAB: CÀI ĐẶT -->
            <div id="tab-settings" class="tab-content items-center justify-center p-6">
                <div class="panel-glass p-12 max-w-xl w-full space-y-8 shadow-2xl border-t-2 border-sola-gold">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-sola-gold uppercase tracking-[0.2em]">Hệ Thống</h2>
                        <p class="text-xs text-zinc-500 mt-2">Cấu hình linh hồn của Sola Pro</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-zinc-500 uppercase ml-2 tracking-widest">Khóa API (Gemini-2.5-Flash)</label>
                            <input type="password" id="api-key-input" class="input-box w-full px-6 py-4 text-center font-mono text-lg" placeholder="Dán API Key của bạn...">
                        </div>

                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-zinc-500 uppercase ml-2 tracking-widest">Giao diện cá nhân</label>
                            <input type="file" id="bg-upload" accept="image/*" class="hidden" onchange="previewBackground(this)">
                            <label for="bg-upload" class="input-box w-full px-6 py-4 flex items-center justify-center gap-3 cursor-pointer hover:bg-white/5 border-dashed">
                                <i class="fa-solid fa-image"></i> Thay đổi ảnh nền
                            </label>
                            <button onclick="removeBackground()" class="w-full text-[10px] text-red-500 font-bold hover:underline py-2">Khôi phục nền mặc định</button>
                        </div>
                    </div>

                    <button onclick="saveSettings()" class="bg-sola-gold w-full py-5 rounded-xl text-white font-bold text-xl shadow-lg hover:brightness-110 active:scale-95 transition-all">LƯU CẤU HÌNH</button>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        let apiKey = "";
        let chaptersContent = [];
        let currentChapterIndex = 0;
        let isAutoTranslating = false;

        window.onload = function() {
            initDustFX();
            
            // Luôn mặc định Dark Mode v1.0
            const savedTheme = localStorage.getItem('sola_v1_theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.remove('dark');
                document.getElementById('dark-icon').classList.replace('fa-moon', 'fa-sun');
            }

            const savedBg = localStorage.getItem('sola_v1_bg');
            if (savedBg) { document.body.style.backgroundImage = `url(${savedBg})`; }

            loadSettings();
            document.getElementById('note-area').value = localStorage.getItem('sola_v1_notes') || "";
            switchTab('tab-translate');
        };

        function initDustFX() {
            const container = document.getElementById('dust-layer');
            for(let i=0; i<40; i++) {
                const dot = document.createElement('div');
                dot.className = 'dust';
                dot.style.left = Math.random() * 100 + 'vw';
                dot.style.width = dot.style.height = (Math.random() * 3 + 1) + 'px';
                dot.style.setProperty('--d', (Math.random() * 20 + 10) + 's');
                dot.style.animationDelay = (Math.random() * 10) + 's';
                container.appendChild(dot);
            }
        }

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark');
            const icon = document.getElementById('dark-icon');
            icon.classList.toggle('fa-moon', isDark);
            icon.classList.toggle('fa-sun', !isDark);
            localStorage.setItem('sola_v1_theme', isDark ? 'dark' : 'light');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById('nav-' + tabId).classList.add('active');
        }

        async function callGemini(prompt, text) {
            if (!apiKey) {
                alert("Hệ thống chưa nạp API Key! Vui lòng vào phần Cài đặt.");
                switchTab('tab-settings');
                return null;
            }
            const notes = document.getElementById('note-area').value;
            const fullPrompt = `Ghi chú thuật ngữ/Văn phong cần tuân thủ:\n${notes}\n\n${prompt}\n\nVĂN BẢN CẦN XỬ LÝ:\n${text}`;
            try {
                const res = await fetch(`${API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Kết quả không hợp lệ.";
            } catch (err) {
                return "HỆ THỐNG GẶP LỖI: " + err.message;
            }
        }

        async function executeTranslate() {
            const input = document.getElementById('trans-input').value;
            if(!input) return;
            const style = document.getElementById('trans-style').value;
            const custom = document.getElementById('custom-prompt').value;
            const prompt = `Dịch văn bản sau sang tiếng Việt. Văn phong yêu cầu: ${style}. Ghi chú: ${custom}. Chỉ trả về phần nội dung đã dịch, không giải thích gì thêm.`;
            
            document.getElementById('loading-trans').classList.remove('hidden');
            const res = await callGemini(prompt, input);
            document.getElementById('trans-output').value = res;
            document.getElementById('loading-trans').classList.add('hidden');
        }

        async function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;
            chaptersContent = [];
            
            if(file.name.endsWith('.epub')) {
                const zip = await JSZip.loadAsync(file);
                const container = await zip.file("META-INF/container.xml").async("string");
                const opfPath = container.match(/full-path="([^"]+)"/)[1];
                const opfFolder = opfPath.includes('/') ? opfPath.substring(0, opfPath.lastIndexOf('/')+1) : "";
                const opf = await zip.file(opfPath).async("string");
                const xml = new DOMParser().parseFromString(opf, "text/xml");
                const spine = Array.from(xml.getElementsByTagName("itemref"));
                const items = Array.from(xml.getElementsByTagName("item"));
                for(let ref of spine) {
                    const item = items.find(i => i.getAttribute("id") === ref.getAttribute("idref"));
                    if(item) {
                        const content = await zip.file(opfFolder + item.getAttribute("href")).async("string");
                        const html = new DOMParser().parseFromString(content, "text/html");
                        const title = html.querySelector('h1,h2,h3,title')?.innerText || `Đoạn ${chaptersContent.length+1}`;
                        const raw = html.body.innerText.trim();
                        // Tự động chia chương nếu text quá dài (> 5000 ký tự)
                        if(raw.length > 5000) {
                            const parts = raw.match(/[\s\S]{1,4000}/g) || [];
                            parts.forEach((p, idx) => {
                                chaptersContent.push({title: `${title} (Phần ${idx+1})`, raw: p, trans: ""});
                            });
                        } else if(raw.length > 20) {
                            chaptersContent.push({title, raw, trans: ""});
                        }
                    }
                }
            } else {
                const text = await file.text();
                // Tự động chia text file thành các phần nhỏ để dịch chính xác hơn
                const parts = text.match(/[\s\S]{1,4000}/g) || [];
                parts.forEach((p, idx) => {
                    chaptersContent.push({title: `Chương ${idx+1}`, raw: p, trans: ""});
                });
            }
            renderChapterList();
            displayChapter(0);
        }

        function renderChapterList() {
            const list = document.getElementById('chapter-list');
            list.innerHTML = chaptersContent.map((ch, i) => `
                <button onclick="displayChapter(${i})" class="w-full text-left p-3 rounded-lg text-[11px] truncate transition-all ${i === currentChapterIndex ? 'bg-sola-gold text-white font-bold' : 'text-zinc-500 hover:bg-zinc-800'}">
                    ${ch.title}
                </button>
            `).join('');
        }

        function displayChapter(idx) {
            if(idx < 0 || idx >= chaptersContent.length) return;
            currentChapterIndex = idx;
            const ch = chaptersContent[idx];
            document.getElementById('current-chapter-title').innerText = ch.title;
            document.getElementById('reader-raw').innerText = ch.raw;
            document.getElementById('reader-trans').innerText = ch.trans || "Chương này chưa được dịch. Nhấn 'Dịch trang này' hoặc 'Dịch tự động'.";
            renderChapterList();
        }

        function navChapter(d) { displayChapter(currentChapterIndex + d); }

        async function translateCurrentChapter() {
            const ch = chaptersContent[currentChapterIndex];
            if(!ch) return;
            document.getElementById('loading-reader').classList.remove('hidden');
            const res = await callGemini("Dịch đoạn văn này sang tiếng Việt một cách tự nhiên và mượt mà nhất:", ch.raw);
            ch.trans = res;
            document.getElementById('reader-trans').innerText = res;
            document.getElementById('loading-reader').classList.add('hidden');
        }

        async function toggleAutoTranslate() {
            isAutoTranslating = !isAutoTranslating;
            const btn = document.getElementById('btn-auto-trans');
            btn.classList.toggle('bg-sola-gold', isAutoTranslating);
            btn.classList.toggle('text-white', isAutoTranslating);
            btn.innerText = isAutoTranslating ? "Dừng dịch tự động" : "Dịch tự động";
            
            if(isAutoTranslating) {
                for(let i = currentChapterIndex; i < chaptersContent.length; i++) {
                    if(!isAutoTranslating) break;
                    if(!chaptersContent[i].trans) {
                        displayChapter(i);
                        await translateCurrentChapter();
                        // Độ trễ 1.5s để tránh spam API
                        await new Promise(r => setTimeout(r, 1500));
                    }
                }
            }
        }

        function cleanText(type) {
            let val = document.getElementById('cleaner-input').value;
            if (type === 'html') val = val.replace(/<[^>]*>?/gm, '');
            if (type === 'zh') val = val.replace(/[\u4e00-\u9fa5\u3040-\u30ff\uac00-\ud7af]/g, '');
            if (type === 'space') val = val.replace(/\s+/g, ' ').trim();
            document.getElementById('cleaner-output').value = val;
        }

        async function handleCleanerFile(input) {
            const file = input.files[0];
            if(!file) return;
            const text = await file.text();
            document.getElementById('cleaner-input').value = text;
        }

        async function executeAnalyze() {
            const input = document.getElementById('analyze-input').value;
            if(!input) return;
            const out = document.getElementById('analyze-output');
            out.classList.remove('hidden');
            out.innerText = "Đang thẩm định nội dung...";
            out.innerText = await callGemini("Phân tích chi tiết văn bản này (ngữ pháp, từ khó, ý nghĩa ẩn dụ, và gợi ý cách dịch hay nhất):", input);
        }

        function saveSettings() {
            apiKey = document.getElementById('api-key-input').value.trim();
            localStorage.setItem('sola_v1_api_key', apiKey);
            alert("Đã lưu cấu hình hệ thống!");
        }

        function loadSettings() {
            apiKey = localStorage.getItem('sola_v1_api_key') || "";
            document.getElementById('api-key-input').value = apiKey;
        }

        function previewBackground(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.body.style.backgroundImage = `url(${e.target.result})`;
                    localStorage.setItem('sola_v1_bg', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeBackground() {
            document.body.style.backgroundImage = "";
            localStorage.removeItem('sola_v1_bg');
        }

        function saveNotes() { localStorage.setItem('sola_v1_notes', document.getElementById('note-area').value); }
        function resetApp() { if(confirm("Xác nhận làm mới pháp khí?")) window.location.reload(); }
    </script>
</body>
</html>

